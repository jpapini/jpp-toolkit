name: Setup Git
description: Sets up Git with SSH commit signing using provided SSH keys.

branding:
    icon: git-commit
    color: blue

inputs:
    ssh-public-key:
        description: The SSH public key used for signing commits.
        required: true
    ssh-private-key:
        description: The SSH private key used for signing commits.
        required: true
    git-committer-name:
        description: The name to use for the Git committer.
        required: true
    git-committer-email:
        description: The email to use for the Git committer.
        required: true
    enable-signing:
        description: Enable commit and tag signing.
        required: false
        default: 'true'

runs:
    using: composite
    steps:
        - name: Setup Git with SSH signing
          shell: bash
          env:
              SSH_PUBLIC_KEY: ${{ inputs.ssh-public-key }}
              SSH_PRIVATE_KEY: ${{ inputs.ssh-private-key }}
              GIT_COMMITTER_NAME: ${{ inputs.git-committer-name }}
              GIT_COMMITTER_EMAIL: ${{ inputs.git-committer-email }}
              ENABLE_SIGNING: ${{ inputs.enable-signing }}
          run: |
              set -e

              # Setup SSH keys
              mkdir -p ~/.ssh
              echo "$SSH_PRIVATE_KEY" > ~/.ssh/signing_key
              chmod 600 ~/.ssh/signing_key
              echo "$SSH_PUBLIC_KEY" > ~/.ssh/signing_key.pub
              chmod 644 ~/.ssh/signing_key.pub

              # Setup allowed signers for verification
              echo "$GIT_COMMITTER_EMAIL namespaces=\"git\" $SSH_PUBLIC_KEY" > ~/.ssh/allowed_signers

              # Configure Git
              git config user.name "$GIT_COMMITTER_NAME"
              git config user.email "$GIT_COMMITTER_EMAIL"

              # Configure SSH signing
              if [[ "$ENABLE_SIGNING" == "true" ]]; then
                  git config gpg.format ssh
                  git config gpg.ssh.allowedSignersFile ~/.ssh/allowed_signers
                  git config user.signingkey ~/.ssh/signing_key.pub
                  git config commit.gpgsign true
                  git config tag.gpgsign true
                  echo "Git configured with SSH signing enabled"
              else
                  echo "Git configured without signing"
              fi
